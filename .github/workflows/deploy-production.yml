# ============================================================================
# DÃ‰PLOIEMENT PRODUCTION SIMPLIFIÃ‰ - QADHYA
# ============================================================================
# Workflow GitHub Actions simplifiÃ© utilisant scripts/deploy.sh
#
# Architecture:
#   - 5 jobs au lieu de 11 (-55%)
#   - 280 lignes au lieu de 761 (-63%)
#   - 0 duplication (scripts helper rÃ©utilisables)
#   - Docker uniquement (plus de Tier 1/2)
#
# Jobs:
#   1. validate    - Validation pre-deploy (schema + RAG + TypeScript)
#   2. build       - Build & push image Docker GHCR
#   3. deploy      - DÃ©ploiement VPS via scripts/deploy.sh
#   4. verify      - Health check + E2E tests
#   5. notify      - Rapport final (success/failed)
#
# DurÃ©e estimÃ©e: 5-8 minutes
# ============================================================================

name: Deploy Production

run-name: "Deploy #${{ github.run_number }} - ${{ github.event.head_commit.message || 'manual' }}"

on:
  # DÃ‰SACTIVÃ‰: ce workflow est remplacÃ© par deploy-vps.yml (2-tier Lightning/Docker)
  # RÃ©activer uniquement pour tests via workflow_dispatch
  workflow_dispatch:

concurrency:
  group: deploy-production
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ==========================================================================
  # Job 1: Validate - Validation Pre-Deploy
  # ==========================================================================
  validate:
    name: Validation Pre-Deploy
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validation consolidÃ©e
        run: bash scripts/pre-deploy-validation.sh

      - name: Rapport validation
        if: success()
        run: |
          echo "âœ… Validation rÃ©ussie"
          echo "  - Schema .env.template: OK"
          echo "  - Configuration RAG: OK"
          echo "  - TypeScript: OK"

  # ==========================================================================
  # Job 2: Build - Build & Push Docker Image GHCR
  # ==========================================================================
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: validate
    timeout-minutes: 20

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest
            type=sha,prefix={{branch}}-

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.repository.updated_at }}
            GIT_SHA=${{ github.sha }}

  # ==========================================================================
  # Job 3: Deploy - DÃ©ploiement VPS via scripts/deploy.sh
  # ==========================================================================
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 84.247.165.187 >> ~/.ssh/known_hosts

      - name: Upload deployment scripts
        uses: appleboy/scp-action@v0.1.7
        with:
          host: 84.247.165.187
          username: root
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "scripts/deploy.sh,scripts/lib/"
          target: /opt/qadhya/

      - name: Upload configuration files
        uses: appleboy/scp-action@v0.1.7
        with:
          host: 84.247.165.187
          username: root
          key: ${{ secrets.VPS_SSH_KEY }}
          source: ".env.template,docker-compose.yml"
          target: /opt/qadhya/

      - name: Update secrets from GitHub
        run: |
          ssh root@84.247.165.187 << 'EOF'
            cd /opt/qadhya

            # Update secrets dans .env.production
            export RESEND_API_KEY="${{ secrets.RESEND_API_KEY }}"
            export GROQ_API_KEY="${{ secrets.GROQ_API_KEY }}"
            export GOOGLE_API_KEY="${{ secrets.GOOGLE_API_KEY }}"
            export DEEPSEEK_API_KEY="${{ secrets.DEEPSEEK_API_KEY }}"
            export OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}"
            export ANTHROPIC_API_KEY="${{ secrets.ANTHROPIC_API_KEY }}"
            export BREVO_API_KEY="${{ secrets.BREVO_API_KEY }}"
            export CRON_SECRET="${{ secrets.CRON_SECRET }}"

            bash scripts/update-secrets-from-gha.sh .env.production.local
          EOF

      - name: Execute deployment
        run: |
          ssh root@84.247.165.187 << 'EOF'
            cd /opt/qadhya

            # Rendre scripts exÃ©cutables
            chmod +x scripts/deploy.sh
            chmod +x scripts/lib/*.sh

            # DÃ©ploiement via script unifiÃ©
            bash scripts/deploy.sh \
              --env=prod \
              --skip-build \
              --force
          EOF

  # ==========================================================================
  # Job 4: Verify - Health Check & Tests E2E
  # ==========================================================================
  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 84.247.165.187 >> ~/.ssh/known_hosts

      - name: Health check avec retry
        run: bash scripts/gha-health-check.sh https://qadhya.tn/api/health root@84.247.165.187

      - name: Test API dÃ©ploiement
        run: |
          # Test endpoint validation dÃ©ploiement
          response=$(curl -s https://qadhya.tn/api/test-deploy || echo '{"error":"not_found"}')
          echo "Response: $response"

          # VÃ©rifier status OK
          if echo "$response" | grep -q '"status":"ok"'; then
            echo "âœ… API dÃ©ploiement OK"
          else
            echo "âš ï¸  API test-deploy non disponible (peut-Ãªtre normal)"
          fi

      - name: Validation configuration deployed
        run: |
          # RÃ©cupÃ©rer hash config deployed
          deployed_hash=$(curl -s https://qadhya.tn/api/health | jq -r '.config_hash // "unknown"')
          echo "Config hash deployed: $deployed_hash"

          # Note: Validation complÃ¨te nÃ©cessite expected_hash (Ã  implÃ©menter)

  # ==========================================================================
  # Job 5: Notify - Rapport Final
  # ==========================================================================
  notify:
    name: Notification Finale
    runs-on: ubuntu-latest
    needs: [validate, build, deploy, verify]
    if: always()
    timeout-minutes: 2

    steps:
      - name: Rapport dÃ©ploiement
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "  RAPPORT DÃ‰PLOIEMENT #${{ github.run_number }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Commit: ${{ github.sha }}"
          echo "Branche: ${{ github.ref_name }}"
          echo "Auteur: ${{ github.actor }}"
          echo "Message: ${{ github.event.head_commit.message }}"
          echo ""
          echo "Status Jobs:"
          echo "  - Validate: ${{ needs.validate.result }}"
          echo "  - Build: ${{ needs.build.result }}"
          echo "  - Deploy: ${{ needs.deploy.result }}"
          echo "  - Verify: ${{ needs.verify.result }}"
          echo ""

          if [ "${{ needs.verify.result }}" = "success" ]; then
            echo "âœ… DÃ‰PLOIEMENT RÃ‰USSI"
            echo ""
            echo "Application: https://qadhya.tn"
            echo "Dashboard: https://qadhya.tn/super-admin/monitoring"
          else
            echo "âŒ DÃ‰PLOIEMENT Ã‰CHOUÃ‰"
            echo ""
            echo "VÃ©rifier les logs des jobs ci-dessus"
            echo "Rollback manuel si nÃ©cessaire:"
            echo "  ssh root@84.247.165.187 'cd /opt/qadhya && bash scripts/deploy.sh --rollback'"
          fi

      - name: Set deployment status
        if: needs.verify.result == 'success'
        run: echo "ğŸ‰ DÃ©ploiement production complÃ©tÃ© avec succÃ¨s"

      - name: Deployment failed
        if: needs.verify.result != 'success'
        run: |
          echo "ğŸ’¥ DÃ©ploiement Ã©chouÃ© - Action requise"
          exit 1
