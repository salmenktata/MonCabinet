# =============================================================================
# Deploy to VPS - Intelligent 2-Tier Deployment
# =============================================================================
# Tier 1 "Lightning Deploy" (~2-3 min) : Code-only changes
#   ‚Üí Build Next.js in GHA, rsync to VPS, docker cp, restart
# Tier 2 "Docker Deploy" (~5-8 min) : Dependencies/infra changes
#   ‚Üí Full Docker build with GHA cache
#
# Selection automatique basee sur les fichiers modifies
# =============================================================================

name: Deploy to VPS Contabo

# Timeout global pour √©viter queues infinies
run-name: "Deploy #${{ github.run_number }} (${{ github.event.head_commit.message || 'manual trigger' }})"

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_docker:
        description: 'Force Docker rebuild (Tier 2)'
        required: false
        type: boolean
        default: false

concurrency:
  group: deploy-production
  cancel-in-progress: false  # Laisser d√©ploiement se terminer

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ===========================================================================
  # Job 0: Check Queue - √âviter queues infinies
  # ===========================================================================
  check-queue:
    runs-on: ubuntu-latest
    name: Check Queue
    outputs:
      should_skip: ${{ steps.check.outputs.should_skip }}
      queue_length: ${{ steps.check.outputs.queue_length }}
    timeout-minutes: 2

    steps:
      - name: Check pending deployments
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Compter les runs en queue/in_progress pour ce workflow
          PENDING=$(gh run list \
            --repo ${{ github.repository }} \
            --workflow="Deploy to VPS Contabo" \
            --status=queued,in_progress \
            --json databaseId,status \
            --jq 'length' || echo "0")

          echo "queue_length=$PENDING" >> $GITHUB_OUTPUT
          echo "üìä D√©ploiements en queue/en cours: $PENDING"

          # Skip si 3+ d√©ploiements d√©j√† en attente (auto-batch)
          # Logic: Si 3+ runs en queue, seul le dernier est pertinent
          if [ "$PENDING" -ge 3 ]; then
            echo "should_skip=true" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è  SKIP: $PENDING d√©ploiements en queue (auto-batch)"
            echo "Le dernier d√©ploiement inclura ces changements"
          else
            echo "should_skip=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Proceeding with deployment"
          fi

  # ===========================================================================
  # Job 1: Detect Changes - Choisir Tier 1 (fast) ou Tier 2 (docker)
  # ===========================================================================
  detect-changes:
    runs-on: ubuntu-latest
    name: Detect Changes
    needs: check-queue
    if: needs.check-queue.outputs.should_skip != 'true'
    outputs:
      needs_docker: ${{ steps.check.outputs.needs_docker }}
      deploy_tier: ${{ steps.check.outputs.deploy_tier }}
    timeout-minutes: 3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check changed files
        id: check
        run: |
          # Force Docker if requested
          if [ "${{ inputs.force_docker }}" == "true" ]; then
            echo "needs_docker=true" >> $GITHUB_OUTPUT
            echo "deploy_tier=2-docker-forced" >> $GITHUB_OUTPUT
            echo "Force Docker rebuild requested"
            exit 0
          fi

          # Get the diff range
          BEFORE="${{ github.event.before }}"
          if [ -z "$BEFORE" ] || [ "$BEFORE" == "0000000000000000000000000000000000000000" ]; then
            BEFORE="HEAD~1"
          fi

          CHANGED=$(git diff --name-only "$BEFORE" HEAD 2>/dev/null || echo "FORCE_DOCKER")

          echo "Changed files:"
          echo "$CHANGED"
          echo "---"

          # Check if any infra/dependency files changed
          DOCKER_TRIGGERS="Dockerfile|package\.json|package-lock\.json|docker-entrypoint\.sh|docker-compose\.prod\.yml"

          if echo "$CHANGED" | grep -qE "^($DOCKER_TRIGGERS)$"; then
            echo "needs_docker=true" >> $GITHUB_OUTPUT
            echo "deploy_tier=2-docker-auto" >> $GITHUB_OUTPUT
            echo "Infrastructure files changed -> Tier 2 (Docker)"
          elif echo "$CHANGED" | grep -q "FORCE_DOCKER"; then
            echo "needs_docker=true" >> $GITHUB_OUTPUT
            echo "deploy_tier=2-docker-fallback" >> $GITHUB_OUTPUT
            echo "Cannot determine changes -> Tier 2 (Docker) as fallback"
          else
            echo "needs_docker=false" >> $GITHUB_OUTPUT
            echo "deploy_tier=1-lightning" >> $GITHUB_OUTPUT
            echo "Code-only changes -> Tier 1 (Lightning)"
          fi

  # ===========================================================================
  # Job 2a: Lightning Deploy (Tier 1) - Code only, ~2-3 min
  # ===========================================================================
  deploy-fast:
    runs-on: ubuntu-latest
    name: Lightning Deploy
    needs: detect-changes
    if: needs.detect-changes.outputs.needs_docker == 'false' && github.ref == 'refs/heads/main'
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          cat >> ~/.ssh/config << EOF
          Host vps
            HostName ${{ secrets.VPS_HOST }}
            Port ${{ secrets.VPS_PORT }}
            User ${{ secrets.VPS_USER }}
            IdentityFile ~/.ssh/id_rsa
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
          EOF
          chmod 600 ~/.ssh/config

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Cache Next.js build
        uses: actions/cache@v4
        with:
          path: .next/cache
          key: nextjs-${{ hashFiles('package-lock.json') }}-${{ hashFiles('app/**', 'lib/**', 'components/**') }}
          restore-keys: |
            nextjs-${{ hashFiles('package-lock.json') }}-

      - name: Build Next.js
        run: npx next build
        env:
          NODE_OPTIONS: "--max-old-space-size=4096 --require ./scripts/polyfill-file.js"
          DATABASE_URL: "postgresql://build:build@localhost:5432/build"
          NEXTAUTH_SECRET: "build-secret-not-used-in-production"
          NEXTAUTH_URL: "http://localhost:3000"
          RESEND_API_KEY: "re_build_placeholder"
          OPENAI_API_KEY: "sk-build-placeholder"
          NEXT_TELEMETRY_DISABLED: "1"

      - name: Prepare deploy bundle
        run: |
          # Copy static assets into standalone structure
          cp -r .next/static .next/standalone/.next/static
          cp -r public .next/standalone/public

          # Create tarball WITHOUT node_modules (container keeps its own native modules)
          cd .next/standalone
          tar czf ../../deploy.tar.gz --exclude='node_modules' .
          cd ../..

          SIZE=$(du -sh deploy.tar.gz | cut -f1)
          echo "Deploy bundle: $SIZE"

      - name: Backup current code on VPS
        run: |
          ssh vps << 'BACKUP'
            mkdir -p /opt/moncabinet/rollback
            docker cp qadhya-nextjs:/app/server.js /opt/moncabinet/rollback/server.js 2>/dev/null || true
            docker cp qadhya-nextjs:/app/.next /opt/moncabinet/rollback/.next 2>/dev/null || true
            docker cp qadhya-nextjs:/app/public /opt/moncabinet/rollback/public 2>/dev/null || true
            echo "Backup completed at $(date)"
          BACKUP

      - name: Upload deploy scripts
        run: |
          # Upload deploy-with-lock.sh to VPS if not exists
          scp scripts/deploy-with-lock.sh vps:/opt/moncabinet/scripts/deploy-with-lock.sh || true
          scp scripts/check-deploy-lock.sh vps:/opt/moncabinet/scripts/check-deploy-lock.sh || true
          ssh vps 'chmod +x /opt/moncabinet/scripts/deploy-with-lock.sh /opt/moncabinet/scripts/check-deploy-lock.sh'

      - name: Upload and deploy
        run: |
          # SCP deploy bundle to VPS
          scp deploy.tar.gz vps:/tmp/deploy.tar.gz

          # Extract and docker cp into container (PROTECTED BY LOCK)
          ssh vps << 'DEPLOY'
            set -e

            # Wrapper pour protection concurrence
            bash /opt/moncabinet/scripts/deploy-with-lock.sh bash -c '
              set -e

              # Extract bundle
              rm -rf /tmp/deploy-bundle
              mkdir -p /tmp/deploy-bundle
              tar xzf /tmp/deploy.tar.gz -C /tmp/deploy-bundle

              # Clean old build artifacts to avoid stale chunks (docker cp merges, not replaces)
              docker exec qadhya-nextjs rm -rf /app/.next/server/chunks /app/.next/server/app /app/.next/static || true

              # Copy into running container (server.js, .next/, public/)
              docker cp /tmp/deploy-bundle/server.js qadhya-nextjs:/app/server.js
              docker cp /tmp/deploy-bundle/.next/. qadhya-nextjs:/app/.next/
              docker cp /tmp/deploy-bundle/public/. qadhya-nextjs:/app/public/

              # Fix permissions (docker cp copie avec root, pas nextjs)
              docker exec -u root qadhya-nextjs chown -R nextjs:nodejs /app/.next /app/public /app/server.js

              # Restart container to pick up new code
              docker restart qadhya-nextjs

              # Cleanup
              rm -rf /tmp/deploy-bundle /tmp/deploy.tar.gz

              echo "Lightning deploy completed at $(date)"
            '
          DEPLOY

      - name: Health check
        run: |
          echo "================================================"
          echo "Waiting 30s for container (Docker start_period: 40s)..."
          sleep 30

          for i in 1 2 3; do
            echo "================================================"
            echo "Health check attempt $i/3 ($(date '+%H:%M:%S'))"

            # V√©rifier PostgreSQL
            PG_STATUS=$(ssh vps 'docker exec qadhya-postgres pg_isready -U moncabinet 2>&1' || echo "FAIL")
            echo "PostgreSQL: $PG_STATUS"

            # V√©rifier MinIO
            MINIO_STATUS=$(ssh vps 'curl -sf http://localhost:9000/minio/health/live 2>&1' || echo "FAIL")
            echo "MinIO: ${MINIO_STATUS:0:50}"

            # Health check API
            RESPONSE=$(ssh vps 'curl -sf http://localhost:3000/api/health' || echo "FAILED")
            echo "API Response: $RESPONSE"

            if echo "$RESPONSE" | grep -q '"status":"healthy"'; then
              echo "================================================"
              echo "‚úì Health check PASSED!"
              DEPLOYED_SHA=$(ssh vps "docker inspect qadhya-nextjs --format='{{.Config.Labels.org.opencontainers.image.revision}}' 2>/dev/null" || echo "N/A (Lightning Deploy)")
              echo "Deployed SHA: $DEPLOYED_SHA"
              echo "================================================"
              exit 0
            fi

            if [ $i -lt 3 ]; then
              echo "Waiting 15s before retry..."
              sleep 15
            fi
          done

          echo "================================================"
          echo "‚úó Health check FAILED after 3 attempts"
          echo "================================================"
          exit 1

      - name: Rollback on failure
        if: failure()
        run: |
          echo "================================================"
          echo "‚ö† ROLLBACK TRIGGERED - Deployment failed"
          echo "================================================"

          ssh vps << 'ROLLBACK'
            # Capturer informations √©chec
            FAILED_SHA=$(docker inspect qadhya-nextjs --format='{{.Config.Labels.org.opencontainers.image.revision}}' 2>/dev/null || echo "unknown")
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)

            echo "Failed deployment SHA: $FAILED_SHA"
            echo "Timestamp: $(date)"

            # Sauvegarder logs
            mkdir -p /opt/moncabinet/failed-deployments
            docker logs qadhya-nextjs --tail 200 > "/opt/moncabinet/failed-deployments/logs_${TIMESTAMP}.txt" 2>&1

            # Cr√©er rapport incident (avec echo multi-lignes, pas de heredoc)
            {
              echo "ROLLBACK INCIDENT REPORT"
              echo "========================"
              echo "Time: $(date)"
              echo "Failed SHA: $FAILED_SHA"
              echo "Logs: logs_${TIMESTAMP}.txt"
              echo ""
              echo "Services Status:"
              echo "- PostgreSQL: $(docker exec qadhya-postgres pg_isready -U moncabinet 2>&1 || echo 'FAIL')"
              echo "- MinIO: $(curl -sf http://localhost:9000/minio/health/live 2>&1 || echo 'FAIL')"
              echo "- Container started: $(docker inspect qadhya-nextjs --format='{{.State.StartedAt}}' 2>/dev/null)"
              echo ""
              echo "Next Steps:"
              echo "1. Review logs: cat /opt/moncabinet/failed-deployments/logs_${TIMESTAMP}.txt"
              echo "2. Check GitHub Actions logs for build errors"
              echo "3. Fix issue locally and redeploy"
            } > "/opt/moncabinet/failed-deployments/incident_${TIMESTAMP}.txt"

            echo "Incident report saved: /opt/moncabinet/failed-deployments/incident_${TIMESTAMP}.txt"

            # Ex√©cuter rollback
            if [ -f /opt/moncabinet/rollback/server.js ]; then
              echo "Restoring previous version..."
              docker cp /opt/moncabinet/rollback/server.js qadhya-nextjs:/app/server.js
              docker cp /opt/moncabinet/rollback/.next/. qadhya-nextjs:/app/.next/
              docker cp /opt/moncabinet/rollback/public/. qadhya-nextjs:/app/public/
              docker restart qadhya-nextjs

              echo "Rollback completed, waiting for health..."
              sleep 20

              if curl -sf http://localhost:3000/api/health | grep -q '"status":"healthy"'; then
                echo "‚úì Rollback successful - application healthy"
              else
                echo "‚ö† WARNING: Rollback health check failed"
              fi
            else
              echo "‚ö† No rollback backup available"
            fi
          ROLLBACK

          echo "================================================"
          echo "Rollback procedure completed"
          echo "================================================"

  # ===========================================================================
  # Job 2b: Docker Deploy (Tier 2) - Full rebuild, ~5-8 min with cache
  # ===========================================================================
  build-and-deploy:
    runs-on: ubuntu-latest
    name: Docker Deploy
    needs: detect-changes
    if: needs.detect-changes.outputs.needs_docker == 'true' && github.ref == 'refs/heads/main'
    timeout-minutes: 20
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Upload deploy scripts
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            mkdir -p /opt/moncabinet/scripts

      - name: Copy scripts to VPS
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          scp -i ~/.ssh/id_rsa -P ${{ secrets.VPS_PORT }} -o StrictHostKeyChecking=no \
            scripts/deploy-with-lock.sh scripts/check-deploy-lock.sh \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/opt/moncabinet/scripts/
          ssh -i ~/.ssh/id_rsa -P ${{ secrets.VPS_PORT }} -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            'chmod +x /opt/moncabinet/scripts/deploy-with-lock.sh /opt/moncabinet/scripts/check-deploy-lock.sh'

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          command_timeout: 10m
          script: |
            cd /opt/moncabinet

            # Wrapper pour protection concurrence
            bash scripts/deploy-with-lock.sh bash -c '
              set -e

              # Mettre a jour les secrets
              sed -i "s|RESEND_API_KEY=.*|RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}|" .env
              sed -i "s|BREVO_API_KEY=.*|BREVO_API_KEY=${{ secrets.BREVO_API_KEY }}|" .env
              sed -i "s|GOOGLE_API_KEY=.*|GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}|" .env
              sed -i "s|GROQ_API_KEY=.*|GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}|" .env
              sed -i "s|DEEPSEEK_API_KEY=.*|DEEPSEEK_API_KEY=${{ secrets.DEEPSEEK_API_KEY }}|" .env
              sed -i "s|ENCRYPTION_KEY=.*|ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }}|" .env
              sed -i "s|CRON_SECRET=.*|CRON_SECRET=${{ secrets.CRON_SECRET }}|" .env

              # Pull et deployer
              docker pull ghcr.io/salmenktata/moncabinet:latest
              docker compose -f docker-compose.prod.yml up -d nextjs

              # Cleanup anciennes images
              docker image prune -f
            '

      - name: Health check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            echo "================================================"
            echo "Waiting 30s for container (Docker start_period: 40s)..."
            sleep 30

            for i in 1 2 3; do
              echo "================================================"
              echo "Health check attempt $i/3 ($(date '+%H:%M:%S'))"

              # V√©rifier services
              PG_STATUS=$(docker exec qadhya-postgres pg_isready -U moncabinet 2>&1 || echo "FAIL")
              echo "PostgreSQL: $PG_STATUS"

              MINIO_STATUS=$(curl -sf http://localhost:9000/minio/health/live 2>&1 || echo "FAIL")
              echo "MinIO: ${MINIO_STATUS:0:50}"

              # Health check API
              RESPONSE=$(curl -sf http://localhost:3000/api/health || echo "FAILED")
              echo "API Response: $RESPONSE"

              if echo "$RESPONSE" | grep -q '"status":"healthy"'; then
                echo "================================================"
                echo "‚úì Health check PASSED!"
                DEPLOYED_SHA=$(docker inspect qadhya-nextjs --format='{{.Config.Labels.org.opencontainers.image.revision}}' 2>/dev/null || echo "unknown")
                echo "Deployed SHA: $DEPLOYED_SHA"
                echo "Deployment successful!"
                echo "================================================"
                exit 0
              fi

              if [ $i -lt 3 ]; then
                echo "Waiting 15s before retry..."
                sleep 15
              fi
            done

            echo "================================================"
            echo "‚úó Health check FAILED after 3 attempts"
            echo "================================================"
            exit 1

  # ===========================================================================
  # Job 3: Skip Notification (si auto-batch)
  # ===========================================================================
  notify-skip:
    runs-on: ubuntu-latest
    name: Auto-Batch Skip
    needs: check-queue
    if: needs.check-queue.outputs.should_skip == 'true'
    timeout-minutes: 1

    steps:
      - name: Report skip reason
        run: |
          QUEUE_LENGTH="${{ needs.check-queue.outputs.queue_length }}"
          echo "================================================"
          echo "‚è≠Ô∏è  DEPLOYMENT SKIPPED (Auto-Batch)"
          echo "================================================"
          echo "Raison: $QUEUE_LENGTH d√©ploiements d√©j√† en queue/en cours"
          echo "Le dernier d√©ploiement en queue inclura ces changements"
          echo ""
          echo "Pour forcer le d√©ploiement malgr√© la queue:"
          echo "  gh workflow run 'Deploy to VPS Contabo'"
          echo "================================================"

  # ===========================================================================
  # Job 4: Notification
  # ===========================================================================
  notify:
    runs-on: ubuntu-latest
    name: Notify Status
    needs: [check-queue, detect-changes, deploy-fast, build-and-deploy]
    if: always() && github.ref == 'refs/heads/main'
    timeout-minutes: 2

    steps:
      - name: Report result
        run: |
          SKIPPED="${{ needs.check-queue.outputs.should_skip }}"
          TIER="${{ needs.detect-changes.outputs.deploy_tier }}"
          FAST="${{ needs.deploy-fast.result }}"
          DOCKER="${{ needs.build-and-deploy.result }}"

          echo "Queue Skip: $SKIPPED | Tier: $TIER | Fast: $FAST | Docker: $DOCKER"

          if [ "$SKIPPED" == "true" ]; then
            echo "‚úÖ Deployment skipped (auto-batch) - OK"
            exit 0
          elif [ "$FAST" == "success" ]; then
            echo "‚úÖ Lightning Deploy (Tier 1) successful!"
          elif [ "$DOCKER" == "success" ]; then
            echo "‚úÖ Docker Deploy (Tier 2) successful!"
          elif [ "$FAST" == "skipped" ] && [ "$DOCKER" == "skipped" ]; then
            echo "No deployment triggered"
          else
            echo "‚ùå Deployment FAILED (tier: $TIER)"
            exit 1
          fi
