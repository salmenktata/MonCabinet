# ============================================================================
# QADHYA UNIFIED ENVIRONMENT TEMPLATE
# ============================================================================
# Template unique auto-adaptatif pour dev local ET production
# Copier ce fichier vers .env et remplir les valeurs
# Commande: cp .env.template .env
# ============================================================================
#
# ðŸš¨ RÃˆGLES CRITIQUES - Ã€ LIRE AVANT CONFIGURATION
# ============================================================================
#
# 1. OLLAMA_ENABLED + RAG_ENABLED
#    - Si RAG_ENABLED=true, alors OLLAMA_ENABLED=true OU OPENAI_API_KEY requis
#    - Ne JAMAIS mettre OLLAMA_ENABLED=false si RAG_ENABLED=true sans provider embeddings
#    - Bug rÃ©current (3Ã— Feb 2026): OLLAMA_ENABLED=false â†’ Assistant rÃ©pond "Ù„Ù… Ø£Ø¬Ø¯ ÙˆØ«Ø§Ø¦Ù‚"
#
# 2. CONTEXTE AUTO-ADAPTATIF
#    - Variables ${OLLAMA_CONTEXT}, ${DB_CONTEXT}, etc. dÃ©tectÃ©es automatiquement
#    - Docker: host.docker.internal, minio, redis, postgres
#    - Local: localhost pour tous les services
#    - Script: bash scripts/detect-env-context.sh (auto-sourcÃ© au dÃ©marrage)
#
# 3. SEUILS RAG OPTIMISÃ‰S (Benchmarks Feb 2026)
#    - RAG_THRESHOLD_KB=0.30 (Ollama embeddings arabes scored 0.35-0.55)
#    - RAG_SIMILARITY_THRESHOLD=0.50 (global minimum)
#    - Ne PAS modifier sans tests benchmark (voir memory/rag-eval-benchmark.md)
#
# 4. SECRETS MANAGEMENT
#    - Secrets sensibles dans .env.secrets (gitignored, validation pre-commit)
#    - Templates disponibles: .env.secrets.template
#    - Validation: bash scripts/validate-secrets.sh
#
# ============================================================================

# ----------------------------------------------------------------------------
# Application
# ----------------------------------------------------------------------------
NODE_ENV=${NODE_ENV:-production}
NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL:-https://qadhya.tn}
NEXT_PUBLIC_APP_NAME=Qadhya
NEXT_PUBLIC_APP_DOMAIN=${NEXT_PUBLIC_APP_DOMAIN:-qadhya.tn}
PORT=3000

# ----------------------------------------------------------------------------
# Database PostgreSQL
# ----------------------------------------------------------------------------
# Auto-adaptatif: DB_CONTEXT dÃ©tectÃ© par detect-env-context.sh
# Docker: postgres | Local: localhost
DATABASE_URL=postgresql://${DB_USER}:${DB_PASSWORD}@${DB_CONTEXT:-localhost}:5432/${DB_NAME}
DB_USER=moncabinet
DB_PASSWORD=YOUR_DB_PASSWORD_HERE
DB_NAME=qadhya
DATABASE_SSL=false

# ----------------------------------------------------------------------------
# MinIO Storage
# ----------------------------------------------------------------------------
# Auto-adaptatif: MINIO_CONTEXT dÃ©tectÃ© par detect-env-context.sh
# Docker: minio | Local: localhost
MINIO_ENDPOINT=${MINIO_CONTEXT:-localhost}
MINIO_PORT=9000
MINIO_USE_SSL=false
MINIO_ACCESS_KEY=YOUR_MINIO_ACCESS_KEY_HERE
MINIO_SECRET_KEY=YOUR_MINIO_SECRET_KEY_HERE
MINIO_ROOT_USER=${MINIO_ACCESS_KEY}
MINIO_ROOT_PASSWORD=${MINIO_SECRET_KEY}
MINIO_BUCKET=documents

# ----------------------------------------------------------------------------
# Redis Cache
# ----------------------------------------------------------------------------
# Auto-adaptatif: REDIS_CONTEXT dÃ©tectÃ© par detect-env-context.sh
# Docker: redis | Local: localhost
REDIS_URL=redis://${REDIS_CONTEXT:-localhost}:6379

# ----------------------------------------------------------------------------
# Auth (JWT HttpOnly)
# ----------------------------------------------------------------------------
NEXTAUTH_URL=${NEXT_PUBLIC_APP_URL}
NEXTAUTH_SECRET=YOUR_JWT_SECRET_HERE

# ----------------------------------------------------------------------------
# Resend Email Service
# ----------------------------------------------------------------------------
RESEND_API_KEY=re_YOUR_RESEND_API_KEY_HERE
RESEND_FROM_EMAIL=notifications@qadhya.tn

# ----------------------------------------------------------------------------
# Brevo Email Service (Notifications quotidiennes)
# ----------------------------------------------------------------------------
BREVO_API_KEY=xkeysib-...
BREVO_SENDER_EMAIL=notifications@qadhya.tn
BREVO_SENDER_NAME=Qadhya
ADMIN_EMAIL=salmen.ktata@gmail.com
ALERT_EMAIL=${ADMIN_EMAIL}

# ----------------------------------------------------------------------------
# Cron Secret (Authentification cron jobs)
# ----------------------------------------------------------------------------
CRON_SECRET=YOUR_CRON_SECRET_HERE
CRON_TRIGGER_SERVER_URL=http://host.docker.internal:9998/trigger

# ----------------------------------------------------------------------------
# Google Drive OAuth Integration (optionnel)
# ----------------------------------------------------------------------------
GOOGLE_CLIENT_ID=YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=YOUR_GOOGLE_CLIENT_SECRET
GOOGLE_REDIRECT_URI=${NEXT_PUBLIC_APP_URL}/api/integrations/google-drive/callback
GOOGLE_DRIVE_WEBHOOK_VERIFY_TOKEN=YOUR_GOOGLE_VERIFY_TOKEN_HERE

# ----------------------------------------------------------------------------
# WhatsApp Business Webhook (optionnel)
# ----------------------------------------------------------------------------
WHATSAPP_WEBHOOK_VERIFY_TOKEN=YOUR_WHATSAPP_VERIFY_TOKEN_HERE
WHATSAPP_APP_SECRET=YOUR_WHATSAPP_APP_SECRET_HERE

# ----------------------------------------------------------------------------
# IA / LLM Configuration
# ----------------------------------------------------------------------------
# Cascade fallback automatique: Groq â†’ Gemini â†’ DeepSeek â†’ Ollama
# Voir: lib/ai/llm-fallback-service.ts

# ðŸš€ Groq (LLM rapide et Ã©conomique - PRIMAIRE si configurÃ©)
# Gratuit, 292ms avg, llama-3.3-70b-versatile
GROQ_API_KEY=gsk_...
GROQ_MODEL=llama-3.3-70b-versatile

# ðŸ§  Google Gemini (LLM secondaire - fallback Groq rate-limited)
# Gratuit tier, 1.5s avg, gemini-2.5-flash
GOOGLE_API_KEY=AIzaSy...
GEMINI_MODEL=gemini-2.5-flash
GEMINI_EMBEDDING_MODEL=gemini-embedding-001

# ðŸ¤– DeepSeek (LLM tertiaire - fallback Gemini)
# ~$0.14/1M tokens, 1.8s avg
DEEPSEEK_API_KEY=sk-...
DEEPSEEK_MODEL=deepseek-chat

# ðŸ”¬ Anthropic Claude (LLM quaternaire - optionnel, coÃ»teux)
# ~$3/1M input tokens, haute qualitÃ©
ANTHROPIC_API_KEY=sk-ant-api03-...
ANTHROPIC_MODEL=claude-sonnet-4-20250514

# ðŸ“Š OpenAI (Embeddings cloud + textes courts KB)
# Embeddings: ~$0.02/1M tokens, text-embedding-3-small (1536-dim)
# Quality analysis textes <500 chars: gpt-4o-mini
# Budget mensuel: $10 (monitoring quotidien 9h, alertes <$5 restant)
OPENAI_API_KEY=sk-proj-...
OPENAI_EMBEDDING_MODEL=text-embedding-3-small
OPENAI_CHAT_MODEL=gpt-4o-mini

# ðŸš¨ CRITIQUE: Ollama (Embeddings locaux - REQUIS pour recherche sÃ©mantique)
# ============================================================================
# Si RAG_ENABLED=true, alors OLLAMA_ENABLED=true OU OPENAI_API_KEY configurÃ©
# Ne JAMAIS mettre false si RAG_ENABLED=true sans OPENAI_API_KEY
# Gratuit, local, rapide - qwen3-embedding:0.6b (1024-dim)
# ============================================================================
OLLAMA_ENABLED=true

# Auto-adaptatif: OLLAMA_CONTEXT dÃ©tectÃ© par detect-env-context.sh
# Docker: host.docker.internal | Local: localhost
OLLAMA_BASE_URL=http://${OLLAMA_CONTEXT:-localhost}:11434
OLLAMA_EMBEDDING_MODEL=qwen3-embedding:0.6b
OLLAMA_CHAT_MODEL=qwen2.5:3b

# ----------------------------------------------------------------------------
# RAG Configuration (OptimisÃ© Benchmarks Feb 2026)
# ----------------------------------------------------------------------------
# RÃ©sultats v5: hit@5 90% (18/20), avgTopScore 0.598
# Doc: memory/rag-eval-benchmark.md
RAG_ENABLED=true

# ðŸŽ¯ Seuils OptimisÃ©s (NE PAS modifier sans tests benchmark)
# ============================================================================
# RAG_THRESHOLD_KB: Seuil arabe Ollama embeddings (scored 0.35-0.55)
# Avant: 0.65 (trop Ã©levÃ©) â†’ AprÃ¨s: 0.30 (optimisÃ© Feb 16, 2026)
# ============================================================================
RAG_THRESHOLD_KB=0.30
RAG_SIMILARITY_THRESHOLD=0.50
RAG_THRESHOLD_DOCUMENTS=0.70
RAG_THRESHOLD_JURISPRUDENCE=0.60
RAG_THRESHOLD_MIN=0.40

# Chunking optimisÃ© (streaming PDF, -60% RAM)
RAG_CHUNK_SIZE=1200
RAG_CHUNK_OVERLAP=200

# Contexte augmentÃ© (Sprint 1 RAG Quality)
RAG_MAX_RESULTS=15
RAG_MAX_CONTEXT_TOKENS=6000

# DiversitÃ© sources
RAG_MAX_CHUNKS_PER_SOURCE=2
RAG_MIN_SOURCES=2

# Quotas IA
AI_MONTHLY_QUOTA_DEFAULT=100
AI_MAX_TOKENS_PER_REQUEST=4000

# Features flags
USE_KB_METADATA_MV=true
USE_REDISEARCH=false
FORCE_REGEX_ONLY=false

# ----------------------------------------------------------------------------
# Chiffrement (tokens Google Drive, clÃ©s API)
# ----------------------------------------------------------------------------
# GÃ©nÃ©rer: openssl rand -hex 32
ENCRYPTION_KEY=YOUR_64_CHAR_HEX_KEY_HERE

# ----------------------------------------------------------------------------
# Backup System
# ----------------------------------------------------------------------------
BACKUP_DIR=/opt/backups/qadhya
BACKUP_SERVER_URL=http://host.docker.internal:9999/backup

# ----------------------------------------------------------------------------
# PgAdmin (Optionnel - Dev local uniquement)
# ----------------------------------------------------------------------------
PGADMIN_EMAIL=salmen.ktata@gmail.com
PGADMIN_PASSWORD=YOUR_PGADMIN_PASSWORD_HERE

# ============================================================================
# COMMANDES POUR GÃ‰NÃ‰RER LES SECRETS
# ============================================================================
#
# DB_PASSWORD (32 chars):
#   openssl rand -base64 32 | tr -d "=+/" | cut -c1-32
#
# MINIO_SECRET_KEY (32 chars):
#   openssl rand -base64 32 | tr -d "=+/" | cut -c1-32
#
# NEXTAUTH_SECRET (32 chars):
#   openssl rand -base64 32
#
# CRON_SECRET (32 chars):
#   openssl rand -base64 32
#
# ENCRYPTION_KEY (64 chars hex):
#   openssl rand -hex 32
#
# GOOGLE_DRIVE_WEBHOOK_VERIFY_TOKEN (32 chars):
#   openssl rand -hex 16
#
# WHATSAPP_WEBHOOK_VERIFY_TOKEN (20 chars):
#   openssl rand -hex 10
#
# ============================================================================
# VALIDATION CONFIGURATION
# ============================================================================
#
# Valider template unifiÃ©:
#   bash scripts/validate-env-unified.sh .env
#
# Valider config RAG:
#   bash scripts/validate-rag-config.sh .env
#
# Valider secrets (pre-commit hook):
#   bash scripts/validate-secrets.sh
#
# Health check production:
#   curl -s https://qadhya.tn/api/health | jq '.rag'
#
# ============================================================================
