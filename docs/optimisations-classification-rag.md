# üöÄ Optimisations du Syst√®me de Classification RAG

Bas√© sur le test de la page 9anoun.tn, voici les am√©liorations possibles.

## üìä √âtat Actuel

**R√©sultat du test :**
- ‚úÖ Classification correcte : `legislation` / `civil` / `loi`
- ‚ö†Ô∏è Confiance : 75% (peut √™tre am√©lior√©)
- ‚ö° Performance : 13ms (excellent)
- ‚ùå Pas de r√®gles configur√©es
- ‚ùå Pas de mots-cl√©s extraits
- ‚ùå LLM jamais utilis√©

---

## üéØ Am√©liorations Prioritaires

### 1. üìã Cr√©er des R√®gles de Classification pour 9anoun.tn

**Probl√®me** : Aucune r√®gle configur√©e, donc on se repose uniquement sur la structure
**Impact** : ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (Critique)
**Effort** : Faible

**Action** :
```sql
-- R√®gle pour les codes juridiques
INSERT INTO source_classification_rules (
  web_source_id,
  name,
  priority,
  url_pattern,
  target_category,
  target_domain,
  target_document_type
) VALUES
  -- Articles de codes
  (
    (SELECT id FROM web_sources WHERE base_url LIKE '%9anoun.tn%'),
    'Articles de codes juridiques',
    100,
    '/kb/codes/.*-article-\d+$',
    'legislation',
    'civil', -- √Ä adapter selon le code
    'loi'
  ),
  -- D√©cisions de jurisprudence
  (
    (SELECT id FROM web_sources WHERE base_url LIKE '%9anoun.tn%'),
    'D√©cisions de jurisprudence',
    90,
    '/kb/jurisprudence/',
    'jurisprudence',
    NULL,
    'arret'
  );
```

**B√©n√©fice attendu** : Confiance de 75% ‚Üí 90%+

---

### 2. üîç Extraction de Mots-cl√©s Juridiques Sans LLM

**Probl√®me** : Aucun mot-cl√© extrait actuellement
**Impact** : ‚≠ê‚≠ê‚≠ê‚≠ê (Important)
**Effort** : Moyen

**Solution** : Cr√©er un extracteur de mots-cl√©s bas√© sur dictionnaire

```typescript
// lib/web-scraper/legal-keywords-extractor.ts
const LEGAL_KEYWORDS_AR_FR = {
  // Droit civil
  'ÿπŸÇÿØ': { fr: 'contrat', domain: 'civil', type: 'concept' },
  'ÿßŸÑÿ™ÿ≤ÿßŸÖ': { fr: 'obligation', domain: 'civil', type: 'concept' },
  'ÿ¨ŸÜÿ≠ÿ©': { fr: 'd√©lit', domain: 'penal', type: 'infraction' },

  // Proc√©dure
  'ŸÇÿ±ÿßÿ±': { fr: 'arr√™t', domain: null, type: 'document' },
  'ÿ≠ŸÉŸÖ': { fr: 'jugement', domain: null, type: 'document' },

  // Codes
  'ŸÖÿ¨ŸÑÿ©': { fr: 'code', domain: null, type: 'source' },
  'ŸÅÿµŸÑ': { fr: 'article', domain: null, type: 'structure' },
}

export function extractLegalKeywords(
  text: string,
  language: 'ar' | 'fr' | 'mixed'
): KeywordMatch[] {
  const keywords: KeywordMatch[] = []
  const textLower = text.toLowerCase()

  for (const [keyword, meta] of Object.entries(LEGAL_KEYWORDS_AR_FR)) {
    if (textLower.includes(keyword.toLowerCase())) {
      keywords.push({
        keyword,
        translation: meta.fr,
        domain: meta.domain,
        type: meta.type,
        occurrences: (text.match(new RegExp(keyword, 'gi')) || []).length
      })
    }
  }

  return keywords.sort((a, b) => b.occurrences - a.occurrences)
}
```

**B√©n√©fice** :
- Enrichissement s√©mantique gratuit
- Aide √† la recherche
- Validation de la classification

---

### 3. üóÇÔ∏è Int√©gration Active avec la Taxonomie

**Probl√®me** : La taxonomie existe mais n'est pas utilis√©e dans la classification
**Impact** : ‚≠ê‚≠ê‚≠ê‚≠ê (Important)
**Effort** : Moyen

**Solution** : Valider et enrichir avec la taxonomie

```typescript
// Apr√®s classification, enrichir avec la taxonomie
const taxonomyDomain = await lookupTaxonomy(result.domain)
if (taxonomyDomain) {
  // Sugg√©rer des sous-domaines
  const subdomains = await getChildrenOf(result.domain)

  // Affiner selon le contenu
  for (const subdomain of subdomains) {
    if (contentMatchesSubdomain(content, subdomain)) {
      result.subdomain = subdomain.code
      result.confidenceScore += 0.05
    }
  }
}
```

**B√©n√©fice** :
- Classification plus pr√©cise (domain ‚Üí subdomain)
- Coh√©rence avec la taxonomie officielle
- Suggestions de nouvelles cat√©gories

---

### 4. üß† Apprentissage et Cache de Patterns

**Probl√®me** : Chaque page est class√©e from scratch
**Impact** : ‚≠ê‚≠ê‚≠ê (Moyen)
**Effort** : Moyen

**Solution** : M√©moriser les patterns qui fonctionnent

```typescript
interface LearnedPattern {
  urlPattern: string
  titlePattern: string
  classification: {
    category: string
    domain: string
    documentType: string
  }
  successRate: number
  sampleCount: number
}

// Apr√®s validation humaine ou haute confiance
async function learnPattern(page: WebPage, classification: Classification) {
  if (classification.confidenceScore > 0.85 || classification.validatedBy) {
    await createClassificationRule({
      webSourceId: page.webSourceId,
      name: `Appris automatiquement: ${page.url}`,
      urlPattern: extractPattern(page.url),
      targetCategory: classification.primaryCategory,
      targetDomain: classification.domain,
      priority: 50, // Moins prioritaire que les r√®gles manuelles
      autoGenerated: true,
    })
  }
}
```

**B√©n√©fice** :
- Le syst√®me s'am√©liore au fil du temps
- R√©duction progressive de l'utilisation du LLM
- √âconomies de co√ªts

---

### 5. üìö Enrichissement Contextuel

**Probl√®me** : Chaque page est isol√©e
**Impact** : ‚≠ê‚≠ê‚≠ê (Moyen)
**Effort** : √âlev√©

**Solution** : Utiliser le contexte des pages voisines

```typescript
// Analyser les pages du m√™me code
const siblingPages = await db.query(`
  SELECT legal_domain, document_nature, COUNT(*) as count
  FROM web_pages wp
  JOIN legal_classifications lc ON wp.id = lc.web_page_id
  WHERE wp.url LIKE $1 AND wp.id != $2
  GROUP BY legal_domain, document_nature
  ORDER BY count DESC
  LIMIT 1
`, [`${getCodeBaseUrl(url)}%`, pageId])

if (siblingPages.rows.length > 0) {
  // Boost la confiance si coh√©rent avec les siblings
  const majority = siblingPages.rows[0]
  if (result.domain === majority.legal_domain) {
    result.confidenceScore = Math.min(0.95, result.confidenceScore + 0.15)
    result.signalsUsed.push({
      source: 'context',
      evidence: `${majority.count} pages similaires class√©es ${majority.legal_domain}`
    })
  }
}
```

**B√©n√©fice** :
- Coh√©rence au sein d'un m√™me code
- Confiance accrue
- D√©tection d'anomalies

---

### 6. üé® Am√©lioration de la D√©tection de Structure

**Probl√®me** : Bug d'affichage "undefined" pour les indices
**Impact** : ‚≠ê‚≠ê (Faible - cosm√©tique mais important pour debug)
**Effort** : Faible

**Solution** :
```typescript
// lib/web-scraper/site-structure-extractor.ts
export interface StructuralHint {
  source: 'url' | 'breadcrumb' | 'navigation' | 'heading' | 'metadata'
  suggestedCategory: string | null
  suggestedDomain: string | null
  suggestedDocumentType: string | null
  confidence: number
  evidence: string
  // üëá Ajouter le d√©tail pour debug
  hint: string // "URL match pattern '/codes/'"
  category?: string
  domain?: string
  documentType?: string
}
```

---

### 7. üèéÔ∏è Optimisations de Performance

**Probl√®me** : 13ms c'est bien, mais on peut faire mieux pour du batch
**Impact** : ‚≠ê‚≠ê‚≠ê (Important pour crawl massif)
**Effort** : Moyen

**Solutions** :

#### A. Batch Classification
```typescript
export async function classifyBatch(
  pageIds: string[],
  concurrency = 5
): Promise<Map<string, ClassificationResult>> {
  const results = new Map()

  // Pr√©-charger toutes les donn√©es en 1 query
  const pages = await db.query(`
    SELECT wp.*, ws.name, ws.category
    FROM web_pages wp
    JOIN web_sources ws ON wp.web_source_id = ws.id
    WHERE wp.id = ANY($1)
  `, [pageIds])

  // Classifier en parall√®le avec limite de concurrence
  await pMap(pages.rows, async (page) => {
    results.set(page.id, await classifyPage(page))
  }, { concurrency })

  return results
}
```

#### B. Cache Redis pour les R√®gles
```typescript
// Cache les r√®gles en m√©moire/Redis pour √©viter les queries
let rulesCache: Map<string, Rule[]> | null = null

async function getCachedRules(sourceId: string): Promise<Rule[]> {
  const cacheKey = `rules:${sourceId}`

  let cached = await redis.get(cacheKey)
  if (cached) return JSON.parse(cached)

  const rules = await matchRules(sourceId, ...)
  await redis.setex(cacheKey, 3600, JSON.stringify(rules))
  return rules
}
```

**B√©n√©fice** :
- 13ms ‚Üí 5ms par page
- Batch de 1000 pages : ~5s au lieu de 13s
- R√©duction de la charge DB

---

### 8. üìä Monitoring et M√©triques

**Probl√®me** : Pas de visibilit√© sur la qualit√© au fil du temps
**Impact** : ‚≠ê‚≠ê‚≠ê‚≠ê (Important pour am√©lioration continue)
**Effort** : Moyen

**Solution** : Dashboard de m√©triques

```typescript
interface ClassificationMetrics {
  // Performance
  avgConfidenceScore: number
  medianConfidenceScore: number
  lowConfidenceCount: number // < 0.7

  // Sources
  signalUsage: {
    structure: number
    rules: number
    llm: number
    hybrid: number
  }

  // Co√ªts
  llmCallsCount: number
  totalTokensUsed: number
  estimatedCost: number

  // Qualit√©
  validationRate: number // % n√©cessitant validation
  correctionRate: number // % corrig√©s apr√®s validation

  // Par domaine
  byDomain: Record<string, {
    count: number
    avgConfidence: number
  }>
}

// Endpoint API
GET /api/super-admin/classification/metrics?period=7d
```

---

### 9. üåê Multi-langue Optimis√©

**Probl√®me** : Gestion basique de l'arabe/fran√ßais
**Impact** : ‚≠ê‚≠ê‚≠ê‚≠ê (Important pour la Tunisie)
**Effort** : √âlev√©

**Solutions** :

#### A. D√©tection automatique de langue par section
```typescript
// D√©tecter si l'article est en AR, FR ou mixte
const languageProfile = analyzeLanguageDistribution(content)
// { ar: 0.7, fr: 0.3 } ‚Üí Article principalement en arabe

// Adapter les keywords selon la langue dominante
const keywords = language.ar > 0.5
  ? extractArabicKeywords(content)
  : extractFrenchKeywords(content)
```

#### B. Normalisation de texte arabe
```typescript
// lib/utils/arabic-normalizer.ts
export function normalizeArabic(text: string): string {
  return text
    // Normaliser les hamzas
    .replace(/[ÿ£ÿ•ÿ¢]/g, 'ÿß')
    // Normaliser les alefs
    .replace(/Ÿâ/g, 'Ÿä')
    // Enlever les diacritiques
    .replace(/[\u064B-\u0652]/g, '')
    // Normaliser les espaces
    .trim()
}
```

---

### 10. üîÑ R√©classification Intelligente

**Probl√®me** : Les r√®gles √©voluent, mais les anciennes pages ne sont pas reclass√©es
**Impact** : ‚≠ê‚≠ê‚≠ê (Moyen)
**Effort** : Faible

**Solution** :

```typescript
// Trigger de r√©classification automatique
CREATE OR REPLACE FUNCTION trigger_reclassification()
RETURNS TRIGGER AS $$
BEGIN
  -- Quand une r√®gle est cr√©√©e/modifi√©e
  -- Marquer les pages concern√©es pour r√©classification
  UPDATE web_pages
  SET processing_status = 'pending_reclassification'
  WHERE web_source_id = NEW.web_source_id
    AND url ~ NEW.url_pattern
    AND processing_status = 'classified';

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER on_rule_change
AFTER INSERT OR UPDATE ON source_classification_rules
FOR EACH ROW EXECUTE FUNCTION trigger_reclassification();
```

---

## üéØ Plan d'Action Recommand√©

### Phase 1 : Quick Wins (1-2 jours) ‚ö°
1. ‚úÖ Cr√©er des r√®gles pour 9anoun.tn
2. ‚úÖ Fixer le bug d'affichage des indices
3. ‚úÖ Ajouter extraction de mots-cl√©s basique

**Impact attendu** : Confiance 75% ‚Üí 85%

### Phase 2 : Am√©liorations Core (1 semaine) üöÄ
4. ‚úÖ Int√©gration avec la taxonomie
5. ‚úÖ Apprentissage automatique de patterns
6. ‚úÖ Dashboard de m√©triques

**Impact attendu** :
- R√©duction de 50% des validations manuelles
- Syst√®me auto-am√©liorant

### Phase 3 : Optimisations Avanc√©es (2 semaines) üèÜ
7. ‚úÖ Batch classification
8. ‚úÖ Cache Redis
9. ‚úÖ Multi-langue optimis√©
10. ‚úÖ Enrichissement contextuel

**Impact attendu** :
- Performance x3
- Qualit√© de classification +10%
- Co√ªts LLM -80%

---

## üìà KPIs de Succ√®s

| M√©trique | Actuel | Cible |
|----------|--------|-------|
| Confiance moyenne | 75% | 90% |
| Validation manuelle requise | ? | < 10% |
| Temps de classification | 13ms | < 5ms |
| Utilisation LLM | 0% | < 5% |
| Taux de correction apr√®s validation | ? | < 3% |
| Couverture des r√®gles | 0% | 80% |

---

## üí° Id√©es Bonus

### A. Mode "Apprentissage Supervis√©"
Pendant 1 semaine, classifier avec LLM + valider manuellement
‚Üí G√©n√©rer automatiquement des r√®gles optimales

### B. Classification Collaborative
Permettre aux juristes de sugg√©rer des classifications
‚Üí Crowdsourcing de la connaissance

### C. API de Classification Externe
Exposer le classificateur comme service pour d'autres apps
‚Üí Mon√©tisation potentielle

### D. D√©tection d'Anomalies
Alerter si une page est class√©e diff√©remment de ses voisines
‚Üí Contr√¥le qualit√© automatique
